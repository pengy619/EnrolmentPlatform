@model ArticleDto
@{
    ViewBag.Title = Model.ArticleId.IsEmpty() ? "发布内容" : "编辑内容";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var categories = ViewBag.ArticleCategories as List<ArticleCategoryDto>;
}

<div class="main-wrap">
    <div class="panel">
        <div class="panel-title">
            @(ViewBag.Title)
        </div>
        <div class="panel-body">
            <div class="layui-form margin-top-10">
                <div class="layui-form-item input-inline-400 required">
                    <label class="layui-form-label">标题</label>
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input" name="title" id="title" value="@Model.Title" lay-verify="required">
                    </div>
                </div>
                <div class="layui-form-item input-inline-400 required">
                    <label class="layui-form-label">栏目</label>
                    <div class="layui-input-inline">
                        <select name="classifyId" id="classifyId" lay-verify="required">
                            <option value=""></option>
                            @foreach (var item in categories)
                            {
                                <option value="@item.CategoryId" @(Model.ClassifyId.Equals(item.CategoryId) ? "selected=selected" : "")>@item.CategoryName</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="layui-form-item required">
                    <label class="layui-form-label">正文</label>
                    <div class="layui-input-block" style="width:800px;">
                        <textarea class="layui-textarea" name="content" id="content" style="display: none">
                            @Html.Raw(Model.Content)
                        </textarea>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">摘要</label>
                    <div class="layui-input-block" style="width:800px;">
                        <textarea placeholder="字数1~100字以内" class="layui-textarea" name="abstract" maxlength="100">@Model.Abstract</textarea>
                    </div>
                </div>
                <div class="layui-form-item required">
                    <label class="layui-form-label">图片</label>
                    <div class="layui-input-block">
                        <button class="layui-btn layui-btn-primary" id="upload">上传图片</button>
                        <span>（图片格式为jpg/png/bmp，建议尺寸350*350，最大为2M。）</span>
                        <div class="upload-img-box">
                            @if (!string.IsNullOrEmpty(Model.FilePath))
                            {
                                <div class="img-item">
                                    <div class="cover">
                                        <span class="layui-icon">ဇ</span>
                                    </div>
                                    <img src="@Model.FilePath" alt="">
                                </div>
                            }
                        </div>
                    </div>
                </div>
                <div class="layui-form-item input-inline-400">
                    <label class="layui-form-label"></label>
                    <div class="layui-input-block">
                        <button class="layui-btn layui-btn-normal" data-status="@((int)ArticleStatusEnum.Draft)" lay-submit="" lay-filter="save">保存草稿</button>
                        <button class="layui-btn" data-status="@((int)ArticleStatusEnum.Publish)" lay-submit="" lay-filter="save">发布</button>
                        @*<button class="layui-btn layui-btn-primary" lay-submit="" lay-filter="preview">预览</button>*@
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts{
    @Html.RenderTextAreaEditorScripts()
    <script>
        var isSubmit = true;
        var editor;
        $("#content").createEditor({ width: "100%", height: 300 }, function (e) {
            editor = e;
        });

        $("#upload").click(function () {
            editor.loadPlugin('image', function () {
                editor.plugin.imageDialog({
                    showRemote: false,
                    clickFn: function (url, title, width, height, border, align) {
                        LoadImgBox(url);
                        editor.hideDialog();
                    }
                });
            });
        });

        //加载图片
        function LoadImgBox(url) {
            $(".upload-img-box").empty();
            var html = "<div class=\"img-item\">" +
                "<div class=\"cover\">" +
                "<span class=\"layui-icon\" onclick=\"deletePic(this)\">ဇ</span>" +
                "</div>" +
                "<img src=\"" + url + "\" alt=\"\">" +
                "</div>";
            $(".upload-img-box").html(html);
        }

        //移除图片
        function deletePic(obj) {
            $(".upload-img-box").empty();
        }

        layui.use(['jquery', 'form'], function () {
            var $ = layui.$;
            var form = layui.form;

            form.on('submit(save)', function (data) {
                if ($.trim(editor.html()) == "") {
                    layer.msg('文章正文不能为空！', {
                        icon: 2,
                        time: 2000
                    })
                    return false;
                }


                var imgPath = "";
                if ($(".upload-img-box img").length > 0) {
                    imgPath = $(".upload-img-box img").attr("src");
                }

                if (imgPath == "") {
                    layer.msg('请选择文章图片！', {
                        icon: 2,
                        time: 2000
                    })
                    return false;
                }
                if (ckb_value.length == 0) {
                    layer.msg('请选择发布对象', {
                        icon: 2,
                        time: 2000
                    })
                    return false;
                }

                var param = {
                    ArticleId: "@Model.ArticleId",
                    Title: data.field.title,
                    ClassifyId: data.field.classifyId,
                    Content: editor.html(),
                    Status: $(data.elem).data("status"),
                    Abstract: data.field.abstract,
                    FilePath: imgPath
                };
                if (isSubmit) {
                    isSubmit = false;
                    $.ajax({
                        url: "@Url.Action("AddOrEditArticle", "Article")",
                        type: "post",
                        data: param,
                        dataType: "json",
                        success: function (res) {
                            if (res.IsSuccess) {
                                layer.msg("保存成功", {
                                    icon: 1
                                    , time: 1000
                                }, function () {
                                    location.href = "@Url.Action("Index", "Article")";
                                });
                            } else {
                                layer.msg(res.Info, {
                                    icon: 2
                                    , time: 2000
                                });
                            }
                        },
                        complete: function () {
                            isSubmit = true;
                        }
                    });
                }
            });
        });
    </script>
}