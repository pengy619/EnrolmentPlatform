@using EnrolmentPlatform.Project.DTO.Product;
@{
    ViewBag.Title = Model.VarietiesId.IsEmpty() ? "品种添加" : "品种编辑";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var categories = ViewBag.Categories as List<ProductCategoriesDto>;
}
@model ProductForSpecialtyVarietiesForAdminDto
<style type="text/css">
    .layui-form-label { width: 100px !important; }
</style>
<div class="main-wrap">
    <div class="layui-tab layui-tab-brief card-wrap" lay-filter="docDemoTabBrief">
        <ul class="layui-tab-title">
            <li class="layui-this">基本设置</li>
        </ul>
        <div class="layui-tab-content">
            <div class="layui-tab-item layui-show">
                <div class="layui-form">
                    <div class="layui-form-item">
                        <label class="layui-form-label"><em style="color:#f00; font-style:normal; padding:0 5px;">*</em>农产品分类</label>
                        <div class="layui-input-inline">
                            <select name="categoriesId" id="categoriesId" lay-filter="categoriesId" lay-verify="required">
                                <option value=""></option>
                                @foreach (var item in categories)
                                {
                                    <option value="@item.Id">@item.Name</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label"><em style="color:#f00; font-style:normal; padding:0 5px;">*</em>农产品名称</label>
                        <div class="layui-input-inline">
                            <select name="nameId" id="nameId" lay-filter="nameId" lay-verify="required">
                                <option value=""></option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label"><em style="color:#f00; font-style:normal; padding:0 5px;">*</em>品种</label>
                        <div class="layui-input-inline">
                            <input type="text" name="varietiesName" id="varietiesName" lay-filter="varietiesName" lay-verify="required" value="@((Model!=null&&Model.VarietiesId.Equals(Guid.Empty))?"":Model.VarietiesName)" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">设置规格</label>
                        <div class="layui-input-block">
                            <div class="spec-check-box" id="divFormat">
                                @if (Model != null && Model.ListForProductForSpecialtyFormatNameForSupplierDto != null && Model.ListForProductForSpecialtyFormatNameForSupplierDto.Any())
                                {
                                    foreach (var item in Model.ListForProductForSpecialtyFormatNameForSupplierDto)
                                    {
                                        <div class="row" temp_n="@(item.FormatName)">
                                            <label class="row-label">@(item.FormatName)</label>
                                            @foreach (var item1 in item.Param)
                                            {
                                                <div class="layui-btn-group" temp_p="@(item1)">
                                                    <button type="button" class="layui-btn layui-btn-primary layui-btn-sm">@(item1)</button>
                                                    <button type="button" class="layui-btn layui-btn-primary layui-btn-sm" onclick="deleteCurrDiv(this)">
                                                        <i class="layui-icon">&#xe640;</i>
                                                    </button>
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                            </div>
                            <div style="margin-top:10px;margin-left: 20px;">
                                <button id="add-spec" class="layui-btn layui-btn-warm">添加规格</button>
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label"><em style="color:#f00; font-style:normal; padding:0 5px;">*</em>图片</label>
                        <div class="layui-input-block">
                            <button type="button" class="layui-btn layui-btn-primary" id="upload">批量上传图片</button>
                            <span>（图片格式为jpg/png/bmp，最大为2M，至少上传一张，最多10张。）</span>
                            <div class="upload-img-box" id="upload-img-box"  style="margin-left: 20px;">
                                @if (Model != null && Model.OptionParamForPictureDto != null && Model.OptionParamForPictureDto.Any())
                                {
                                    foreach (var item in Model.OptionParamForPictureDto)
                                    {
                                        <div class="img-item">
                                            <div class="cover @(item.Iscover?"show":"")">
                                                <span onclick="setPic(this)">@(item.Iscover ? "主图" : "设为主图")</span>
                                                <span class="layui-icon" onclick="deletePic(this)">ဇ</span>
                                            </div>
                                            <img src="@item.FilePath" />
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label"></label>
                        <div class="layui-input-block">
                            <button class="layui-btn" lay-submit="" lay-filter="submitVarieties">保存</button>
                            @if (Model.VarietiesId.Equals(Guid.Empty))
                            {
                                <button type="reset" onclick="location.reload();" class="layui-btn layui-btn-primary">重置</button>
                            }
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div id="add-spec-modal" style="display:none">
    <div class="layui-form margin-top-30">
        <div class="layui-form-item ">
            <label class="layui-form-label">规格名称</label>
            <div class="layui-input-inline" style="width: 220px">
                <input type="text" id="add-spec-name" placeholder="规格名称(例如：大小，重量，净含量)" name="name" lay-verify="required" autocomplete="off" class="layui-input">
                <div class="layui-form-mid layui-word-aux">(例如：大小，重量，净含量)</div>
            </div>
        </div>
        <div class="layui-form-item ">
            <label class="layui-form-label">参数</label>
            <div class="layui-input-inline" style="width:220px;">
                <input type="text" id="add-spec-param" placeholder="参数(例如：500G，1Kg，500ml，1L)" name="param" lay-verify="required" autocomplete="off" class="layui-input">
                <div class="layui-form-mid layui-word-aux">(例如：500G，1Kg，500ml，1L)</div>
            </div>
        </div>
        <div class="layui-form-item ">
            <label class="layui-form-label"></label>
        </div>
    </div>
</div>
<div style="display:none;">
    <textarea id="desc" name="desc"></textarea>
</div>
@section scripts{
    @Html.RenderTextAreaEditorScripts()

    <script>
        var defaltGuid = "@(Guid.Empty)";
        var defaltVarietiesId = "@(Model!=null?Model.VarietiesId:Guid.Empty)";
        var defaltSpecialtyNameId = "@(Model!=null?Model.SpecialtyNameId:Guid.Empty)";
        var isSubmit = true;

        var editor;
        $("#desc").createEditor({ width: "100%", height: 300, imageUploadLimit:10 }, function (e) {
            editor = e;
        });

        $("#upload").click(function () {
            var img_len = $(".upload-img-box .img-item").length;
            if (img_len>=10) {
                layer.msg("最多上传10张图片");
            } else {
                editor.loadPlugin('multiimage', function () {
                    editor.plugin.multiImageDialog({
                        showRemote: false,
                        clickFn: function (urlList) {
                            if (urlList.length > 10 - img_len) {
                                layer.msg("最多上传10张图片");
                                return false;
                            } else {
                                $.each(urlList, function (i, data) {
                                    LoadImgBox(data.url, 1);
                                });
                                editor.hideDialog();
                            }
                        }
                    });
                });
                //editor.loadPlugin('image', function () {
                //    editor.plugin.imageDialog({
                //        showRemote: false,
                //        clickFn: function (url, title, width, height, border, align) {
                //            LoadImgBox(url, 1);
                //            editor.hideDialog();
                //        }
                //    });
                //});

            }
        });

        //加载图片
        //type 1：上传图片  2：品种图片
        function LoadImgBox(url, type) {
            var html = "<div class=\"img-item\" data_type=\"" + type+"\">" +
                "<div class=\"cover\">" +
                "<span onclick=\"setPic(this)\">设为主图</span>" +
                "<span class=\"layui-icon\" onclick=\"deletePic(this)\">ဇ</span>" +
                "</div>" +
                "<img src=\"" + url + "\" />" +
                "</div>";
            $(".upload-img-box").append(html);
        }


        //移除图片
        function deletePic(_this) {
            $(_this).parents("div[class='img-item']").remove();
        }

        //设为主图
        function setPic(_this) {
            var isZhutu = $.trim($(_this).text()) == "设为主图";
            $(".upload-img-box .img-item").each(function () {
                $(this).find("div").removeClass("show");
                $(this).find("span:eq(0)").text("设为主图");
            });
            if (isZhutu) {
                $(_this).text("主图");
                $(_this).parent().addClass("show");
            } else {
                $(_this).text("设为主图");
                $(_this).parent().removeClass("show");
            }
        }

        layui.use(['jquery', 'element', 'layer', 'form', 'laydate', 'laytpl'], function () {
            var layer = layui.layer, form = layui.form, element = layui.element;
            var laytpl = layui.laytpl;
            var $ = layui.$;

            //编辑表单赋值
            if (defaltVarietiesId != defaltGuid) {
                $("#categoriesId").val("@(Model!=null? Model.ProductCategoryId:Guid.Empty)");
                GetNamesByCategory("@(Model!=null? Model.ProductCategoryId:Guid.Empty)");
            }

            //切换农产品分类
            form.on("select(categoriesId)", function (data) {
                $("#nameId").html("<option value=''></option>");
                form.render('select');
                if (data.value == "") return false;
                GetNamesByCategory(data.value);
            });

            $('#add-spec').click(function () {
                var varietiesId = $("#varietiesId").val();
                if (varietiesId == "") {
                    layer.msg("请选择一个品种");
                    return false;
                }
                layer.open({
                    type: 1,
                    title: '添加规格',
                    btn: ['确定', '取消'],
                    area: ['500px'], //宽高
                    content: $('#add-spec-modal'),
                    yes: function (index, layero) {
                        var formatName = $.trim($("#add-spec-name").val());
                        var formatParms = $.trim($("#add-spec-param").val());
                        if (formatName.length > 0 && formatParms.length > 0) {
                            AppendHtml(formatName, formatParms);
                        } else {
                            layer.msg("请选择填写名称和参数");
                        }
                    },
                    btn2: function () {

                    }
                });
                return false
            })

            //保存基本设置
            form.on('submit(submitVarieties)', function (data) {
                if ($("#divFormat>div").length <= 0) {
                    layer.msg("请添加规格");
                    return false;
                }
                if ($(".upload-img-box .img-item").length < 1) {
                    layer.msg("请上传一张图片");
                    return false;
                } else if ($(".upload-img-box .img-item .show").length < 1) {
                    layer.msg("请设置一张图片为主图");
                    return false;
                } 
                var param = {
                    VarietiesId: defaltVarietiesId,
                    ProductCategoryId: data.field.categoriesId,
                    SpecialtyNameId: data.field.nameId,
                    VarietiesName: data.field.varietiesName,
                    OptionParamForPictureDto: GetImgArr(),
                    ListForProductForSpecialtyFormatNameForSupplierDto: GetFormatArr()
                };
                if (isSubmit) {
                    isSubmit = false;
                    $.ajax({
                        url: "@Url.Action("OptionBasicInfo", "Specialty")",
                        type: "post",
                        data: param,
                        dataType: "json",
                        success: function (res) {
                            if (res.IsSuccess) {
                                layer.msg("保存成功", {
                                    icon: 1
                                    , time: 2000
                                }, function () {
                                    location.href = '@Url.Action("Varieties", "Specialty")';
                                });
                            } else {
                                layer.msg(res.Info, {
                                    icon: 2
                                    , time: 2000
                                });
                            }
                        },
                        complete: function () {
                            isSubmit = true;
                        }
                    });
                }
            });

            //获取添加的图片
            function GetImgArr() {
                var img_value = [];
                $(".upload-img-box .img-item").each(function () {
                    var path = $(this).find("img").attr("src");
                    var iscover_temp = $.trim($(this).find("span:eq(0)").text()) != "设为主图";
                    var imgObj = { FilePath: path, FileClassify: 1, ForeignKeyClassify: 2, Iscover: iscover_temp, IsFocus: "False" };
                    img_value.push(imgObj);
                });
                return img_value;
            }

            //获取选中的规格
            function GetFormatArr() {
                var format_value = [];
                $("#divFormat .row").each(function () {
                    var formatName = $.trim($(this).attr("temp_n"));
                    if ($(this).find("div").length > 0) {
                        var param_value = [];
                        $(this).find("div").each(function () {
                            param_value.push($(this).attr("temp_p"));
                        });
                        format_value.push({ FormatName: formatName, Param: param_value });
                    }
                }); 
                return format_value;
            }

            //根据分类获取农产品名称
            function GetNamesByCategory(categoriesId) {
                if (isSubmit) {
                    isSubmit = false;
                    $.ajax({
                        url: "@Url.Action("GetSpecialtyNames", "Specialty")",
                        type: "get",
                        data: { categoriesId: categoriesId },
                        dataType: "json",
                        cache: false,
                        success: function (data) {
                            isSubmit = true;
                            if (data.length > 0) {
                                $.each(data, function (key, val) {
                                    var option = "";
                                    if (defaltSpecialtyNameId == val.Id) {
                                        option = "<option selected='selected' value='" + val.Id + "'>" + val.Name + "</option>";
                                    }
                                    else {
                                        option = $("<option>").val(val.Id).text(val.Name);
                                    }
                                    $("#nameId").append(option);
                                });
                                form.render('select');
                            }
                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                            isSubmit = true;
                            layer.msg("系统出现异常，请联系管理员！", "warning");
                        }
                    });
                }
            }

            function AppendHtml(n, p) {
                var n_len = $("#divFormat").find("div[temp_n='" + n + "']").length;
                if (n_len > 0) {
                    var p_len = $("#divFormat").find("div[temp_n='" + n + "']").find("div[temp_p='" + p + "']").length;
                    if (p_len <= 0) {
                        var htmlDiv = "<div class=\"layui-btn-group\" temp_p=\"" + p + "\">";
                        htmlDiv += "<button type=\"button\" class=\"layui-btn layui-btn-primary layui-btn-sm\">" + p + "</button>";
                        htmlDiv += "<button type=\"button\" class=\"layui-btn layui-btn-primary layui-btn-sm\" onclick=\"deleteCurrDiv(this)\"><i class=\"layui-icon\">&#xe640;</i></button></div>";
                        $("#divFormat").find("div[temp_n='" + n + "']").append(htmlDiv);
                    } else { 
                        layer.msg("名称参数已经存在");
                    }
                } else {
                    var htmlDiv = "<div class=\"row\" temp_n=\"" + n + "\"><label class=\"row-label\">" + n + "</label><div class=\"layui-btn-group\" temp_p=\"" + p + "\">";
                    htmlDiv += "<button type=\"button\" class=\"layui-btn layui-btn-primary layui-btn-sm\">" + p + "</button>";
                    htmlDiv += "<button type=\"button\" class=\"layui-btn layui-btn-primary layui-btn-sm\" onclick=\"deleteCurrDiv(this)\"><i class=\"layui-icon\">&#xe640;</i></button></div>";
                    $("#divFormat").append(htmlDiv);
                }
            }
        })

        function deleteCurrDiv(_this) {
            $(_this).parent().remove();
        }
    </script>

} 